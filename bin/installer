#!/bin/sh
set -e -u -x

# Check environment

fail() {
    echo 1>&2 "$1"
    echo 1>&2 "Usage: $(basename "$0") [install|uninstall]"
    exit 255
}

if [ "$#" -lt 1 ]; then
    fail "Invalid number of arguments."
fi

# Run installer

case "$1" in
    install)
        WEBSTORM_CONFIG_FOLDER_PREVIOUS="$(ls -a "${HOME}" | grep ".WebStorm" | tail -n 1)"
        WEBSTORM_CONFIG_FOLDER_NEW="$(grep -E "(\.WebStorm[0-9]{4}\.[0-9]+)" -o /snap/webstorm/current/bin/webstorm.sh | head -n 1)"
        if [ -n "${WEBSTORM_CONFIG_FOLDER_PREVIOUS}" ]; then
            if [ ${WEBSTORM_CONFIG_FOLDER_PREVIOUS} != "${WEBSTORM_CONFIG_FOLDER_NEW}" ]; then
                mv "${HOME}/${WEBSTORM_CONFIG_FOLDER_PREVIOUS}" "${HOME}/${WEBSTORM_CONFIG_FOLDER_NEW}"
            fi
            git -C "${HOME}/${WEBSTORM_CONFIG_FOLDER_NEW}/config" fetch origin
            git -C "${HOME}/${WEBSTORM_CONFIG_FOLDER_NEW}/config" checkout --force origin/master
            rm -f -r $(ls -a "${HOME}" | grep ".WebStorm" | grep -v "${WEBSTORM_CONFIG_FOLDER_NEW}")
        else
            mkdir -p "${HOME}/${WEBSTORM_CONFIG_FOLDER_NEW}"
            git clone "https://github.com/mauchede/webstorm-config" "${HOME}/${WEBSTORM_CONFIG_FOLDER_NEW}/config"
        fi
        ;;

    uninstall)
        rm -f -r $(ls -a "${HOME}" | grep ".WebStorm")
        ;;

    *)
        fail "Argument \"$1\" is invalid."
        ;;
esac
